name: Build Wheels

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare_linux:
    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux_2_28_x86_64
    steps:
      - uses: actions/checkout@v4
      - name: Install System Headers
        run: |
          dnf -y install \
            alsa-lib-devel pipewire-devel pulseaudio-libs-devel \
            libXrandr-devel libXcursor-devel libXi-devel libXinerama-devel libXfixes-devel libXScrnSaver-devel libXtst-devel \
            mesa-libEGL-devel mesa-libgbm-devel \
            wayland-devel wayland-protocols-devel libxkbcommon-devel \
            libpng-devel libjpeg-turbo-devel freetype-devel flac-devel \
            pkgconf-pkg-config

      - name: Build SDL Deps
        run: |
          mkdir -p $(pwd)/linux_deps

          export PKG_CONFIG_PATH=$(pwd)/linux_deps/lib64/pkgconfig:$(pwd)/linux_deps/lib/pkgconfig:$PKG_CONFIG_PATH

          # Build SDL3
          git clone --depth 1 --branch release-3.4.0 https://github.com/libsdl-org/SDL.git
          cmake -S SDL -B build_sdl \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/linux_deps \
            -DSDL_STATIC=ON -DSDL_SHARED=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_sdl --target install --parallel 4

          # Build SDL3_image
          git clone --depth 1 --branch release-3.4.0 https://github.com/libsdl-org/SDL_image.git
          cmake -S SDL_image -B build_image \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/linux_deps \
            -DCMAKE_PREFIX_PATH=$(pwd)/linux_deps \
            -DBUILD_SHARED_LIBS=OFF \
            -DSDLIMAGE_BACKEND_STB=ON \
            -DSDLIMAGE_BUILD_SHARED_LIBS=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_image --target install --parallel 4

          # Build SDL3_ttf
          git clone --depth 1 --branch release-3.2.2 --recurse-submodules https://github.com/libsdl-org/SDL_ttf.git
          cd SDL_ttf
          git submodule update --init --recursive
          cd ..
          cmake -S SDL_ttf -B build_ttf \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/linux_deps \
            -DCMAKE_PREFIX_PATH=$(pwd)/linux_deps \
            -DBUILD_SHARED_LIBS=OFF \
            -DSDLTTF_BUILD_SHARED_LIBS=OFF \
            -DSDLTTF_VENDORED=ON \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_ttf --target install --parallel 4

          # Build SDL3_mixer
          git clone --depth 1 --branch prerelease-3.1.2 --recurse-submodules https://github.com/libsdl-org/SDL_mixer.git
          cd SDL_mixer
          git submodule update --init --recursive
          cd ..
          cmake -S SDL_mixer -B build_mixer \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/linux_deps \
            -DCMAKE_PREFIX_PATH=$(pwd)/linux_deps \
            -DBUILD_SHARED_LIBS=OFF \
            -DSDLMIXER_BUILD_SHARED_LIBS=OFF \
            -DSDLMIXER_VENDORED=ON \
            -DSDLMIXER_OPUS=ON \
            -DSDLMIXER_FLAC_LIBFLAC=ON \
            -DSDLMIXER_MP3_MINIMP3=ON \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_mixer --target install --parallel 4

      - name: Upload Linux Core
        uses: actions/upload-artifact@v4
        with:
          name: linux-core-deps
          path: ./linux_deps

  prepare_macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build SDL Deps
        run: |
          mkdir -p $(pwd)/macos_deps

          export MACOSX_DEPLOYMENT_TARGET=15.0

          # Build SDL3
          git clone --depth 1 --branch release-3.4.0 https://github.com/libsdl-org/SDL.git
          cmake -G Ninja -S SDL -B build_sdl \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/macos_deps \
            -DSDL_STATIC=ON -DSDL_SHARED=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_sdl --target install --parallel 4

          # Build SDL3_image
          git clone --depth 1 --branch release-3.4.0 https://github.com/libsdl-org/SDL_image.git
          cmake -G Ninja -S SDL_image -B build_image \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/macos_deps \
            -DCMAKE_PREFIX_PATH=$(pwd)/macos_deps \
            -DBUILD_SHARED_LIBS=OFF \
            -DSDLIMAGE_BACKEND_STB=ON \
            -DSDLIMAGE_BUILD_SHARED_LIBS=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_image --target install --parallel 4

          # Build SDL3_ttf
          git clone --depth 1 --branch release-3.2.2 --recurse-submodules https://github.com/libsdl-org/SDL_ttf.git
          cmake -G Ninja -S SDL_ttf -B build_ttf \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/macos_deps \
            -DCMAKE_PREFIX_PATH=$(pwd)/macos_deps \
            -DBUILD_SHARED_LIBS=OFF \
            -DSDLTTF_BUILD_SHARED_LIBS=OFF \
            -DSDLTTF_VENDORED=ON \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_ttf --target install --parallel 4

          # Build SDL3_mixer
          git clone --depth 1 --branch prerelease-3.1.2 --recurse-submodules https://github.com/libsdl-org/SDL_mixer.git
          cmake -G Ninja -S SDL_mixer -B build_mixer \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/macos_deps \
            -DCMAKE_PREFIX_PATH=$(pwd)/macos_deps \
            -DBUILD_SHARED_LIBS=OFF \
            -DSDLMIXER_BUILD_SHARED_LIBS=OFF \
            -DSDLMIXER_VENDORED=ON \
            -DSDLMIXER_OPUS=ON \
            -DSDLMIXER_FLAC_LIBFLAC=ON \
            -DSDLMIXER_MP3_MINIMP3=ON \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_mixer --target install --parallel 4

      - name: Upload macOS Core
        uses: actions/upload-artifact@v4
        with:
          name: macos-core-deps
          path: ./macos_deps

  prepare_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build SDL Deps
        shell: powershell
        run: |
          $depsPath = "$(Get-Location)\windows_deps"
          New-Item -ItemType Directory -Force -Path $depsPath

          # Build SDL3
          git clone --depth 1 --branch release-3.4.0 https://github.com/libsdl-org/SDL.git
          cmake -S SDL -B build_sdl `
            -DCMAKE_INSTALL_PREFIX="$depsPath" `
            -DSDL_STATIC=ON -DSDL_SHARED=OFF `
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON `
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_sdl --config Release --target install --parallel 4

          # Build SDL3_image
          git clone --depth 1 --branch release-3.4.0 https://github.com/libsdl-org/SDL_image.git
          cmake -S SDL_image -B build_image `
            -DCMAKE_INSTALL_PREFIX="$depsPath" `
            -DCMAKE_PREFIX_PATH="$depsPath" `
            -DBUILD_SHARED_LIBS=OFF `
            -DSDLIMAGE_BACKEND_STB=ON `
            -DSDLIMAGE_BUILD_SHARED_LIBS=OFF `
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON `
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_image --config Release --target install --parallel 4

          # Build SDL3_ttf
          git clone --depth 1 --branch release-3.2.2 --recurse-submodules https://github.com/libsdl-org/SDL_ttf.git
          cmake -S SDL_ttf -B build_ttf `
            -DCMAKE_INSTALL_PREFIX="$depsPath" `
            -DCMAKE_PREFIX_PATH="$depsPath" `
            -DBUILD_SHARED_LIBS=OFF `
            -DSDLTTF_BUILD_SHARED_LIBS=OFF `
            -DSDLTTF_VENDORED=ON `
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON `
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_ttf --config Release --target install --parallel 4

          # Build SDL3_mixer
          git clone --depth 1 --branch prerelease-3.1.2 --recurse-submodules https://github.com/libsdl-org/SDL_mixer.git
          cmake -S SDL_mixer -B build_mixer `
            -DCMAKE_INSTALL_PREFIX="$depsPath" `
            -DCMAKE_PREFIX_PATH="$depsPath" `
            -DBUILD_SHARED_LIBS=OFF `
            -DSDLMIXER_BUILD_SHARED_LIBS=OFF `
            -DSDLMIXER_VENDORED=ON `
            -DSDLMIXER_OPUS=ON `
            -DSDLMIXER_FLAC_LIBFLAC=ON `
            -DSDLMIXER_MP3_MINIMP3=ON `
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON `
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_mixer --config Release --target install --parallel 4

      - name: Upload Windows Core
        uses: actions/upload-artifact@v4
        with:
          name: windows-core-deps
          path: ./windows_deps

  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    needs: [prepare_linux, prepare_macos, prepare_windows]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v4

      # WINDOWS PREP: Download Pre-built Core
      - name: Download Windows Core
        if: matrix.os == 'windows-latest'
        uses: actions/download-artifact@v4
        with:
          name: windows-core-deps
          path: ./prebuilt_windows

      - name: Debug Windows dependency paths
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"
          Write-Host "Listing prebuilt_windows top-level:"
          Get-ChildItem -Path "${env:GITHUB_WORKSPACE}\prebuilt_windows" -Force
          Write-Host "Searching for SDL3Config.cmake:"
          Get-ChildItem -Path "${env:GITHUB_WORKSPACE}\prebuilt_windows" -Recurse -Filter SDL3Config.cmake | ForEach-Object { $_.FullName }

      # MACOS PREP: Brew and Build Mixer
      - name: Download macOS Core
        if: matrix.os == 'macos-latest'
        uses: actions/download-artifact@v4
        with:
          name: macos-core-deps
          path: ./prebuilt_macos

      # LINUX PREP: Download Pre-built Core
      - name: Download Linux Core
        if: matrix.os == 'ubuntu-latest'
        uses: actions/download-artifact@v4
        with:
          name: linux-core-deps
          path: ./prebuilt_linux

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Build and test wheels
        uses: pypa/cibuildwheel@v3.2.0
        env:
          CIBW_BUILD_FRONTEND: "build[uv]"
          CIBW_MANYLINUX_X86_64_IMAGE: quay.io/pypa/manylinux_2_28_x86_64
          CIBW_SKIP: "*-musllinux_* *-win32"
          CIBW_BUILD: "cp311-* cp312-* cp313-* cp314-*"

          CIBW_ENVIRONMENT_WINDOWS: >
            CMAKE_PREFIX_PATH="${{ github.workspace }}/prebuilt_windows;${{ github.workspace }}/prebuilt_windows/cmake"
            SDL3_DIR="${{ github.workspace }}/prebuilt_windows/cmake"
            SDL3_image_DIR="${{ github.workspace }}/prebuilt_windows/cmake"
            SDL3_ttf_DIR="${{ github.workspace }}/prebuilt_windows/cmake"
            SDL3_mixer_DIR="${{ github.workspace }}/prebuilt_windows/cmake"

          CIBW_CONFIG_SETTINGS_WINDOWS: >
            cmake.define.SDL3_DIR=${{ github.workspace }}/prebuilt_windows/cmake
            cmake.define.SDL3_image_DIR=${{ github.workspace }}/prebuilt_windows/cmake
            cmake.define.SDL3_ttf_DIR=${{ github.workspace }}/prebuilt_windows/cmake
            cmake.define.SDL3_mixer_DIR=${{ github.workspace }}/prebuilt_windows/cmake

          CIBW_ENVIRONMENT_MACOS: >
            MACOSX_DEPLOYMENT_TARGET=15.0
            CMAKE_OSX_DEPLOYMENT_TARGET=15.0
            CMAKE_PREFIX_PATH=${{ github.workspace }}/prebuilt_macos
            DYLD_LIBRARY_PATH=${{ github.workspace }}/prebuilt_macos/lib:${{ github.workspace }}/prebuilt_macos/lib64:$DYLD_LIBRARY_PATH
            DYLD_FALLBACK_LIBRARY_PATH=${{ github.workspace }}/prebuilt_macos/lib:${{ github.workspace }}/prebuilt_macos/lib64:$DYLD_FALLBACK_LIBRARY_PATH

          CIBW_ENVIRONMENT_LINUX: >
            CMAKE_PREFIX_PATH=/host${{ github.workspace }}/prebuilt_linux
            LD_LIBRARY_PATH=/host${{ github.workspace }}/prebuilt_linux/lib:$LD_LIBRARY_PATH

          # Linux still needs standard runtime libs to link against
          CIBW_BEFORE_ALL_LINUX: >
            dnf -y install alsa-lib-devel libXrandr-devel libXcursor-devel mesa-libEGL-devel wayland-devel wayland-protocols-devel

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
