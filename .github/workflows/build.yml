name: Build Wheels

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare_linux:
    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux2014_x86_64
    steps:
      - uses: actions/checkout@v4
      - name: Install System Headers
        run: |
          yum -y install alsa-lib-devel pipewire-devel pulseaudio-libs-devel \
          libXrandr-devel libXcursor-devel libXi-devel libXinerama-devel libXfixes-devel \
          mesa-libEGL-devel wayland-devel libxkbcommon-devel libpng-devel libjpeg-turbo-devel

      - name: Build SDL Dependencies
        run: |
          # Build SDL3
          git clone --depth 1 --branch release-3.4.0 https://github.com/libsdl-org/SDL.git
          cmake -S SDL -B build_sdl -DCMAKE_INSTALL_PREFIX=$(pwd)/linux_deps -DSDL_STATIC=ON -DSDL_SHARED=OFF -DCMAKE_BUILD_TYPE=Release
          cmake --build build_sdl --target install --parallel 4

          # Build SDL3_image
          git clone --depth 1 --branch release-3.4.0 https://github.com/libsdl-org/SDL_image.git
          cmake -S SDL_image -B build_image -DCMAKE_INSTALL_PREFIX=$(pwd)/linux_deps -DSDLIMAGE_BACKEND_STB=ON -DSDLIMAGE_BUILD_SHARED_LIBS=OFF -DCMAKE_PREFIX_PATH=$(pwd)/linux_deps -DCMAKE_BUILD_TYPE=Release
          cmake --build build_image --target install --parallel 4

          # Build SDL3_ttf
          git clone --depth 1 --branch release-3.2.2 https://github.com/libsdl-org/SDL_ttf.git
          cmake -S SDL_ttf -B build_ttf -DCMAKE_INSTALL_PREFIX=$(pwd)/linux_deps -DSDLTTF_BUILD_SHARED_LIBS=OFF -DSDLTTF_VENDORED=ON -DCMAKE_PREFIX_PATH=$(pwd)/linux_deps -DCMAKE_BUILD_TYPE=Release
          cmake --build build_ttf --target install --parallel 4

          # Build SDL3_mixer
          git clone --depth 1 --branch prerelease-3.1.2 https://github.com/libsdl-org/SDL_mixer.git
          cmake -S SDL_mixer -B build_mixer -DCMAKE_INSTALL_PREFIX=$(pwd)/linux_deps -DSDLMIXER_BUILD_SHARED_LIBS=OFF -DSDLMIXER_VENDORED=ON -DSDLMIXER_OPUS=ON -DSDLMIXER_FLAC_LIBFLAC=ON -DSDLMIXER_MP3_MINIMP3=ON -DCMAKE_PREFIX_PATH=$(pwd)/linux_deps -DCMAKE_BUILD_TYPE=Release
          cmake --build build_mixer --target install --parallel 4

      - name: Upload Linux Core
        uses: actions/upload-artifact@v4
        with:
          name: linux-core-deps
          path: ./linux_deps

  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    needs: [prepare_linux]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v4

      # WINDOWS PREP: Fetch SDL VC Zips
      - name: Fetch Windows SDL Binaries
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          mkdir -p vendor

          # SDL3
          curl -L -o sdl3.zip https://github.com/libsdl-org/SDL/releases/download/release-3.4.0/SDL3-devel-3.4.0-VC.zip
          unzip -q sdl3.zip -d ./vendor

          # SDL3_image
          curl -L -o sdl3_image.zip https://github.com/libsdl-org/SDL_image/releases/download/release-3.4.0/SDL3_image-devel-3.4.0-VC.zip
          unzip -q sdl3_image.zip -d ./vendor

          # SDL3_ttf
          curl -L -o sdl3_ttf.zip https://github.com/libsdl-org/SDL_ttf/releases/download/release-3.2.2/SDL3_ttf-devel-3.2.2-VC.zip
          unzip -q sdl3_ttf.zip -d ./vendor

          # SDL3_mixer
          curl -L -o sdl3_mixer.zip https://github.com/libsdl-org/SDL_mixer/releases/download/prerelease-3.1.2/SDL3_mixer-devel-3.1.2-VC.zip
          unzip -q sdl3_mixer.zip -d ./vendor

      # MACOS PREP: Brew and Build Mixer
      - name: Setup macOS Deps
        if: matrix.os == 'macos-latest'
        run: |
          brew install sdl3 sdl3_image sdl3_ttf

          # Build Mixer 3.1.2 manually
          git clone --depth 1 --branch prerelease-3.1.2 https://github.com/libsdl-org/SDL_mixer.git
          cmake -S SDL_mixer -B build_mixer \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/vendor/mixer_install \
            -DSDLMIXER_BUILD_SHARED_LIBS=OFF \
            -DSDLMIXER_VENDORED=ON \
            -DSDLMIXER_OPUS=ON \
            -DSDLMIXER_FLAC_LIBFLAC=ON \
            -DSDLMIXER_MP3_MINIMP3=ON \
            -DCMAKE_PREFIX_PATH=$(brew --prefix) \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_mixer --target install --parallel 4

      # LINUX PREP: Download Pre-built Core
      - name: Download Linux Core
        if: matrix.os == 'ubuntu-latest'
        uses: actions/download-artifact@v4
        with:
          name: linux-core-deps
          path: ./prebuilt_linux

      - name: Build and test wheels
        uses: pypa/cibuildwheel@v3.2.0
        env:
          CIBW_BUILD_FRONTEND: "build[uv]"
          CIBW_SKIP: "*-musllinux_* *-win32"
          CIBW_BUILD: "cp311-* cp312-* cp313-* cp314-*"

          # Pass paths to CMake
          CIBW_ENVIRONMENT_WINDOWS: >
            SDL3_DIR=${{ github.workspace }}/vendor/SDL3-3.4.0
            SDL3_image_DIR=${{ github.workspace }}/vendor/SDL3_image-3.4.0
            SDL3_ttf_DIR=${{ github.workspace }}/vendor/SDL3_ttf-3.2.2
            SDL3_mixer_DIR=${{ github.workspace }}/vendor/SDL3_mixer-3.1.2

          CIBW_ENVIRONMENT_MACOS: >
            CMAKE_PREFIX_PATH=${{ github.workspace }}/vendor/mixer_install

          CIBW_ENVIRONMENT_LINUX: >
            CMAKE_PREFIX_PATH=/host${{ github.workspace }}/prebuilt_linux
            LD_LIBRARY_PATH=/host${{ github.workspace }}/prebuilt_linux/lib:$LD_LIBRARY_PATH

          # Linux still needs standard runtime libs to link against
          CIBW_BEFORE_ALL_LINUX: >
            yum -y install alsa-lib-devel libXrandr-devel libXcursor-devel mesa-libEGL-devel wayland-devel libxkbcommon-devel

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
